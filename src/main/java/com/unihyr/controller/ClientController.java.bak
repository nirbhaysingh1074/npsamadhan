package com.unihyr.controller;

import java.io.File;
import java.io.IOException;
import java.security.Principal;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Set;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;
import javax.validation.Valid;

import org.apache.commons.fileupload.servlet.ServletFileUpload;
import org.apache.commons.io.FilenameUtils;
import org.hibernate.Session;
import org.json.simple.JSONArray;
import org.json.simple.JSONObject;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.multipart.MultipartHttpServletRequest;

import com.google.gson.JsonSerializationContext;
import com.unihyr.constraints.GeneralConfig;
import com.unihyr.constraints.Roles;
import com.unihyr.domain.CandidateProfile;
import com.unihyr.domain.Industry;
import com.unihyr.domain.LoginInfo;
import com.unihyr.domain.Post;
import com.unihyr.domain.PostProfile;
import com.unihyr.domain.Registration;
import com.unihyr.domain.UserRole;
import com.unihyr.model.ClientRegistrationModel;
import com.unihyr.model.PostModel;
import com.unihyr.service.IndustryService;
import com.unihyr.service.LoginInfoService;
import com.unihyr.service.PostProfileService;
import com.unihyr.service.PostService;
import com.unihyr.service.ProfileService;
import com.unihyr.service.RegistrationService;
import com.unihyr.service.UserRoleService;

import scala.sys.process.processInternal;

@Controller
public class ClientController
{
	@Autowired
	private IndustryService industryService;
	@Autowired
	private PostService postService;
	@Autowired
	private RegistrationService registrationService;
	@Autowired
	private LoginInfoService loginInfoService;
	@Autowired
	private UserRoleService userRoleService;
	@Autowired
	private ProfileService profileService;
	@Autowired
	private PostProfileService postProfileService;

	
	
	@RequestMapping(value = "/clientdashboard", method = RequestMethod.GET)
	public String clientDashboard(ModelMap map, Principal principal)
	{
		
		
		
		map.addAttribute("totalposts", postService.countAllPostByClient(principal.getName()));
		map.addAttribute("totalprofiles", postProfileService.countPostProfileByClient(principal.getName()));
		map.addAttribute("totalActive", postService.countActivePostByClient(principal.getName()));
		return "clientDashboard";
	}
	
	@RequestMapping(value = "/clientDashboardList", method = RequestMethod.GET)
	public String clientDashboardList(ModelMap map, HttpServletRequest request ,Principal principal)
	{
		int rpp = GeneralConfig.rpp;
		int pn = Integer.parseInt(request.getParameter("pn"));
		String db_post_status = request.getParameter("db_post_status");
		
		if(db_post_status.equals("active"))
		{
			map.addAttribute("postList", postService.getActivePostsByClient(principal.getName(), (pn - 1) * rpp, rpp));
			map.addAttribute("totalCount", postService.countActivePostByClient(principal.getName()));
		}
		else if(db_post_status.equals("published"))
		{
			map.addAttribute("postList", postService.getPublishedPostsByClient(principal.getName(), (pn - 1) * rpp, rpp));
			map.addAttribute("totalCount", postService.countPublishedPostByClient(principal.getName()));
		}
		else if(db_post_status.equals("saved"))
		{
			
			map.addAttribute("postList", postService.getSavedPostsByClient(principal.getName(), (pn - 1) * rpp, rpp));
			map.addAttribute("totalCount", postService.countSavedPostByClient(principal.getName()));
		}
		else if(db_post_status.equals("closed"))
		{
			map.addAttribute("postList", postService.getClosedPostsByClient(principal.getName(), (pn - 1) * rpp, rpp));
			map.addAttribute("totalCount", postService.countClosedPostByClient(principal.getName()));
		}
		else
		{
			map.addAttribute("postList", postService.getAllPostsByClient(principal.getName(), (pn - 1) * rpp, rpp));
			map.addAttribute("totalCount", postService.countAllPostByClient(principal.getName()));
		}
		
		map.addAttribute("rpp", rpp);
		map.addAttribute("pn", pn);

		return "clientDashboardList";
	}

	

	@RequestMapping(value = "/clientaddpost", method = RequestMethod.GET)
	public String addPost(ModelMap map)
	{
		map.addAttribute("postForm", new PostModel());
		return "addPost";
	}

	@RequestMapping(value = "/clientaddpost", method = RequestMethod.POST)
	public String client_addPost(@ModelAttribute(value = "postForm") @Valid PostModel model, BindingResult result,
			ModelMap map, HttpServletRequest request, Principal principal)
	{
		if (result.hasErrors())
		{
			return "addPost";
		} else
		{
			System.out.println("form submitted successfully");

			Post post = new Post();
			post.setTitle(model.getTitle());
			post.setLocation(model.getLocation());
			post.setFunction(model.getFunction());
			post.setExp_min(model.getExp_min());
			post.setExp_max(model.getExp_max());
			post.setCtc_min(model.getCtc_min());
			post.setCtc_max(model.getCtc_max());
			post.setCriteria(model.getCriteria());
			post.setComment(model.getComment());
			post.setUploadjd(model.getUploadjd());
			post.setAdditionDetail(model.getAdditionDetail());
			
			Date date = new Date();
			java.sql.Date dt = new java.sql.Date(date.getTime());
			
			String btn_response = request.getParameter("btn_response");
			if(btn_response.equals("Publish"))
			{
				post.setPublished(dt);
			}
			post.setCreateDate(dt);
			post.setClient(registrationService.getRegistationByUserId(principal.getName()));
			
			SimpleDateFormat df = new SimpleDateFormat("yyyyMMdd");
			String jobCode = "GEN"+df.format(date);
			long pid = postService.addPost(post);
			
			if(pid < 10)
			{
				jobCode+="000000"+pid;
			}
			else if(pid < 100)
			{
				jobCode+="00000"+pid;
			}
			else if(pid < 1000)
			{
				jobCode+="0000"+pid;
			}
			else if(pid < 10000)
			{
				jobCode+="000"+pid;
			}
			else if(pid < 100000)
			{
				jobCode+="00"+pid;
			}
			else if(pid < 1000000)
			{
				jobCode+="0"+pid;
			}
			else
			{
				jobCode+=""+pid;
			}
			
			post.setJobCode(jobCode);
			postService.updatePost(post);
			
		}
		return "redirect:clientdashboard";
	}

	@RequestMapping(value = "/clienteditpost", method = RequestMethod.GET)
	public String editPost(ModelMap map, @RequestParam long pid)
	{
		Post post = postService.getPost(pid);
		if (post != null)
		{
			PostModel model = new PostModel();

			model.setPostId(post.getPostId());
			model.setTitle(post.getTitle());
			model.setLocation(post.getLocation());
			model.setFunction(post.getFunction());
			model.setExp_min(post.getExp_min());
			model.setExp_max(post.getExp_max());
			model.setCtc_min(post.getCtc_min());
			model.setCtc_max(post.getCtc_max());
			model.setCriteria(post.getCriteria());
			model.setComment(post.getComment());
			model.setUploadjd(post.getUploadjd());
			model.setAdditionDetail(post.getAdditionDetail());
			map.addAttribute("postForm", model);
			return "editPost";
		}
		return "redirect:clientyourpost";
	}

	@RequestMapping(value = "/clienteditpost", method = RequestMethod.POST)
	public String client_editPost(@ModelAttribute(value = "postForm") @Valid PostModel model, BindingResult result,
			ModelMap map, HttpServletRequest request, Principal principal)
	{
		if (result.hasErrors())
		{
			return "editPost";
		} else
		{
			System.out.println("form submitted successfully");
			String btn_response = request.getParameter("btn_response");
			System.out.println("btn_response : " + btn_response);
			
			Post post = postService.getPost(model.getPostId());
			if (post != null)
			{
				post.setTitle(model.getTitle());
				post.setLocation(model.getLocation());
				post.setFunction(model.getFunction());
				post.setExp_min(model.getExp_min());
				post.setExp_max(model.getExp_max());
				post.setCtc_min(model.getCtc_min());
				post.setCtc_max(model.getCtc_max());
				post.setCriteria(model.getCriteria());
				post.setComment(model.getComment());
				post.setUploadjd(model.getUploadjd());
				post.setAdditionDetail(model.getAdditionDetail());
				Date date = new Date();
				java.sql.Date dt = new java.sql.Date(date.getTime());

				if(btn_response.equals("Publish") && post.getPublished() == null)
				{
					post.setPublished(dt);
				}
				
				post.setModifyDate(dt);
				if(!post.getClient().getUserid().endsWith(principal.getName()))
				{
					post.setLastModifier(registrationService.getRegistationByUserId(principal.getName()));
				}
				
				
				postService.updatePost(post);
				
				
			}
		}
		return "redirect:clientdashboard";
	}

	@RequestMapping(value = "/clientyourpost", method = RequestMethod.GET)
	public String yourPost(ModelMap map, HttpServletRequest request)
	{
		return "yourPosts";
	}

	@RequestMapping(value = "/loadclientposts", method = RequestMethod.GET)
	public String loadclientposts(ModelMap map, HttpServletRequest request ,Principal principal)
	{
		int rpp = GeneralConfig.rpp;
		int pn = Integer.parseInt(request.getParameter("pn"));
		map.addAttribute("postList", postService.getAllPostsByClient(principal.getName(), (pn - 1) * rpp, rpp));
		map.addAttribute("totalCount", postService.countAllPostByClient(principal.getName()));
		map.addAttribute("rpp", rpp);
		map.addAttribute("pn", pn);

		return "clientPost";
	}

	@RequestMapping(value = "/clientpostapplicants", method = RequestMethod.GET)
	public String clientpostapplicants(ModelMap map, HttpServletRequest request, Principal principal)
	{
		String pid = request.getParameter("pid");
		System.out.println("pid : " + pid);
		if(pid != null)
		{
			Post post = postService.getPost(Long.parseLong(pid));
			if(post != null)
			{
				map.addAttribute("ppList", postProfileService.getPostProfileByPost(post.getPostId(),0, GeneralConfig.rpp));
				map.addAttribute("totalCount", postProfileService.countPostProfileByPost(post.getPostId()));
				map.addAttribute("rpp", GeneralConfig.rpp);
				map.addAttribute("pn", 1);
				map.addAttribute("sel_post", post);
			}
//			for empty table begin
			else
			{
				map.addAttribute("ppList",new ArrayList<PostProfile>());
				map.addAttribute("totalCount", 0);
				map.addAttribute("rpp", GeneralConfig.rpp);
				map.addAttribute("pn", 1);
				map.addAttribute("sel_post", "");
			}
//			for empty table end
			
		}
		List<Registration> cons = registrationService.getConsultantsByClient(principal.getName());
		map.addAttribute("consList",cons);
		
		map.addAttribute("postsList", postService.getActivePostsByClient(principal.getName()));
		return "clientPostApplicants";
	}

	@RequestMapping(value = "/postapplicantlist", method = RequestMethod.GET)
	public String postApplicantList(ModelMap map, HttpServletRequest request, Principal principal)
	{
		int rpp = GeneralConfig.rpp;
		int pn = Integer.parseInt(request.getParameter("pn"));
		int pid = Integer.parseInt(request.getParameter("pid"));
		String conid = request.getParameter("conid");
		if(pid == 0 && (conid == null || conid.trim().length() == 0))
		{
//			map.addAttribute("ppList", postProfileService.getPostProfileByClient(principal.getName(),(pn - 1) * rpp, rpp));
//			map.addAttribute("totalCount", postProfileService.countPostProfileByClient(principal.getName()));
			map.addAttribute("ppList", new ArrayList<PostProfile>());// postProfileService.getPostProfileByPost(pid,(pn - 1) * rpp, rpp));
			map.addAttribute("totalCount", 0L);//postProfileService.countPostProfileByPost(pid));
		}
		else if(pid > 0 && (conid != null && conid.trim().length() > 0))
		{
			map.addAttribute("ppList", postProfileService.getPostProfileByClientPostAndConsultant(principal.getName(), conid, pid ,(pn - 1) * rpp, rpp));
			map.addAttribute("totalCount", postProfileService.countPostProfileByClientPostAndConsultant(principal.getName(), conid, pid));
		}
		else if(pid == 0 && (conid != null && conid.trim().length() > 0))
		{
			map.addAttribute("ppList", postProfileService.getPostProfileByClientAndConsultant(principal.getName(), conid, (pn - 1) * rpp, rpp));
			map.addAttribute("totalCount", postProfileService.countPostProfileByClientAndConsultant(principal.getName(), conid));
		}
		else
		{
			map.addAttribute("ppList", postProfileService.getPostProfileByPost(pid,(pn - 1) * rpp, rpp));
			map.addAttribute("totalCount", postProfileService.countPostProfileByPost(pid));
		}
		map.addAttribute("rpp", rpp);
		map.addAttribute("pn", pn);
		return "postApplicantList";
	}
	
	
	
	
	
	
	
	
	@RequestMapping(value = "/clientacceptreject", method = RequestMethod.GET)
	public @ResponseBody String clientacceptreject(ModelMap map, HttpServletRequest request, Principal principal)
	{
		JSONObject obj = new JSONObject();
		try
		{
			long ppid = Long.parseLong(request.getParameter("ppid"));
			String ppstatus  = request.getParameter("ppstatus"); 
			PostProfile pp = postProfileService.getPostProfile(ppid);
			
			
			if(pp != null)
			{
				Date date = new Date();
				java.sql.Date dt = new java.sql.Date(date.getTime());
				
				if(ppstatus.equals("accept"))
				{
					pp.setAccepted(dt);
					obj.put("status", "accepted");
				}
				else if(ppstatus.equals("reject"))
				{
					pp.setRejected(dt);
					obj.put("status", "rejected");
				}
				else
				{
					obj.put("status", "failed");
				}
				postProfileService.updatePostProfile(pp);
				return obj.toJSONString();
				
			}
			
			
		} catch (Exception e)
		{
			// TODO: handle exception
		}
		obj.put("status", "failed");
		
		return obj.toJSONString();
	}
	
	@RequestMapping(value = "/postConsultantList", method = RequestMethod.GET)
	public @ResponseBody String postConsultantList(ModelMap map, HttpServletRequest request, Principal principal)
	{
		int pid = Integer.parseInt(request.getParameter("pid"));
		List<Registration> list = null;
		if(pid > 0 )
		{
			list = registrationService.getConsultantsByPost(pid);
		}
//		else
//		{
//			list = registrationService.getConsultantsByClient(principal.getName());
//		}
		JSONObject obj = new JSONObject();
		
		JSONArray cons = new JSONArray();
		if(list != null && !list.isEmpty())
		{
			JSONObject jsonCon = null;
			for(Registration con : list)
			{
				jsonCon = new JSONObject();
				jsonCon.put("conid", con.getUserid());
				jsonCon.put("cname", con.getConsultName());
				cons.add(jsonCon);
			}
		}
		obj.put("consList", cons);
		
		return obj.toJSONString();
	}

	@RequestMapping(value = "/viewPostDetail", method = RequestMethod.GET)
	public String viewPostDetail(ModelMap map, HttpServletRequest request ,Principal principal)
	{
		String pid = request.getParameter("pid");
		if(pid != null && pid.trim().length() > 0)
		{
			Post post = postService.getPost(Long.parseLong(pid));
			if(post != null)
			{
				map.addAttribute("post", post);
				return "viewPostDetail";
			}
			
		}
		return "error";
	}
	
	@RequestMapping(value = "/clientaccount", method = RequestMethod.GET)
	public String clientAccount(ModelMap map, HttpServletRequest request ,Principal principal)
	{
		map.addAttribute("status", request.getParameter("status"));
		return "clientAccount";
	}
	
	@RequestMapping(value = "/clientapplicantinfo", method = RequestMethod.GET)
	public String clientApplicantInfo(ModelMap map, HttpServletRequest request ,Principal principal, @RequestParam long ppid)
	{
		PostProfile postProfile = postProfileService.getPostProfile(ppid);
		
		map.addAttribute("postProfile", postProfile);
		return "clientApplicantInfo";
	}
	
	@RequestMapping(value = "/clientunpublishpost", method = RequestMethod.GET)
	public @ResponseBody String clientunpublishpost(ModelMap map, HttpServletRequest request ,Principal principal, @RequestParam long pid)
	{
		JSONObject object = new JSONObject();
		Post post = postService.getPost(pid);
		if(post != null)
		{
			post.setPublished(null);
			postService.updatePost(post);
			object.put("status", "success");
			return object.toJSONString();
		}
		object.put("status", "failed");
		return object.toJSONString();
	}
	
	@RequestMapping(value = "/clientBulkActive", method = RequestMethod.GET)
	public @ResponseBody String clientBulkActive(ModelMap map, HttpServletRequest request ,Principal principal)
	{
		JSONObject object = new JSONObject();
		String pids = request.getParameter("pids");
		if(pids != null && pids.length() > 0)
		{
			String[] ids = pids.split(",");
			try
			{
				for(String pid : ids)
				{
					Post post = postService.getPost(Long.parseLong(pid.trim()));
					if(post != null)
					{
						post.setActive(true);
						postService.updatePost(post);
					}
				}
				
				object.put("status", "success");
				return object.toJSONString();
			}
			catch(Exception e)
			{
				e.printStackTrace();
			}
		}
		
		
		object.put("status", "failed");
		return object.toJSONString();
	}
	@RequestMapping(value = "/clientBulkInactive", method = RequestMethod.GET)
	public @ResponseBody String clientBulkInactive(ModelMap map, HttpServletRequest request ,Principal principal)
	{
		JSONObject object = new JSONObject();
		String pids = request.getParameter("pids");
		if(pids != null && pids.length() > 0)
		{
			String[] ids = pids.split(",");
			try
			{
				for(String pid : ids)
				{
					Post post = postService.getPost(Long.parseLong(pid.trim()));
					if(post != null)
					{
						post.setActive(false);
						postService.updatePost(post);
					}
				}
				
				object.put("status", "success");
				return object.toJSONString();
			}
			catch(Exception e)
			{
				e.printStackTrace();
			}
		}
		
		
		object.put("status", "failed");
		return object.toJSONString();
	}
	
	
	
	@RequestMapping(value = "/clientpublishpost", method = RequestMethod.GET)
	public @ResponseBody String clientpublishpost(ModelMap map, HttpServletRequest request ,Principal principal, @RequestParam long pid)
	{
		JSONObject object = new JSONObject();
		Post post = postService.getPost(pid);
		if(post != null)
		{
			Date date = new Date();
			java.sql.Date dt = new java.sql.Date(date.getTime());
			post.setPublished(dt);
			postService.updatePost(post);
			object.put("status", "success");
			object.put("jobCode", post.getJobCode());
			return object.toJSONString();
		}
		object.put("status", "failed");
		return object.toJSONString();
	}
	
	
	
	
	
	
	private Set<String> allowedImageExtensions;
	@RequestMapping(value = "/client.uploadLogo", method = RequestMethod.POST)
    public @ResponseBody String ajaxFileUpload(MultipartHttpServletRequest request, HttpServletRequest req, Principal principal)throws ServletException
    {   
		
		this.allowedImageExtensions = new HashSet<String>();
		this.allowedImageExtensions.add("png");
		this.allowedImageExtensions.add("jpg");
		this.allowedImageExtensions.add("jpeg");
		this.allowedImageExtensions.add("gif");
		this.allowedImageExtensions.add("PNG");
		this.allowedImageExtensions.add("JPG");
		this.allowedImageExtensions.add("JPEG");
		this.allowedImageExtensions.add("GIF");
		
		MultipartFile mpf = null;
		int flag=0;
		Iterator<String> itr=request.getFileNames();
		while(itr.hasNext()){
		mpf=request.getFile(itr.next());
		flag++;
        boolean isMultipart=ServletFileUpload.isMultipartContent(request);
        System.out.println("is file " + isMultipart + " file name " + mpf.getOriginalFilename());
		}
		if(flag > 0 && mpf != null && mpf.getOriginalFilename() != null && mpf.getOriginalFilename() != "")
		{
			String filename=null;
			
			filename=mpf.getOriginalFilename().replace(" ", "-");
			String imageextension=FilenameUtils.getExtension(filename);
			try
			{
				if(!this.allowedImageExtensions.contains(imageextension)){
        			return "failed";
        		}
				
				File dl = new File(System.getProperty("catalina.base")+"/unihyr_uploads/"+principal.getName()+"/logo/"+filename);
				String datafile=System.getProperty("catalina.base")+"/unihyr_uploads/"+principal.getName()+"/logo/"+filename;
				System.out.println("PATH="+datafile);
				if(!dl.exists()){
					System.out.println("in not file"+dl.getAbsolutePath());
					dl.mkdirs();
				}
				filename= "/unihyr_uploads/"+principal.getName()+"/logo/"+filename;
				mpf.transferTo(dl);
				Registration registration = registrationService.getRegistationByUserId(principal.getName());
				registration.setLogo(filename);
				request.getSession().setAttribute("registration", registration);
				registrationService.update(registration);
			}
			catch(IOException e)
			{
				
			}
			return filename;
		}
		return "failed";
    }
	
}
